<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç”¢å“æ‹ç«‹è§£</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3687/3687412.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3687/3687412.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        html { height: auto; min-height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: manipulation; }
        body { font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; min-height: 100vh; overflow-y: visible; overflow-x: hidden; position: relative; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .chat-loader { width: 8px; height: 8px; background-color: #9ca3af; border-radius: 50%; animation: chat-dot 1.4s infinite ease-in-out both; display: inline-block; margin: 0 2px; }
        .chat-loader:nth-child(1) { animation-delay: -0.32s; }
        .chat-loader:nth-child(2) { animation-delay: -0.16s; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes chat-dot { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .history-card:active { transform: scale(0.98); background-color: #f9fafb; }
        .cursor-zoom-in { cursor: zoom-in; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col">
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="showInstallPrompt()" class="text-white/90 hover:text-white transition p-1" title="æ”¾åˆ°æ¡Œé¢"><i class="fas fa-download text-lg"></i></button>
                <button onclick="navigateToHistory()" class="text-white/90 hover:text-white transition p-1" title="æ­·å²ç´€éŒ„"><i class="fas fa-history text-lg"></i></button>
                <h1 class="text-xl font-bold">AI ç”¢å“æ‹ç«‹è§£</h1>
            </div>
            <button onclick="resetApp()" class="text-sm bg-blue-700 px-3 py-1 rounded-full hover:bg-blue-800 transition"><i class="fas fa-redo"></i> é‡ä¾†</button>
        </div>
    </header>

    <main class="flex-grow p-4 max-w-md mx-auto w-full pb-20">
        
        <div id="uploadSection" class="bg-white rounded-2xl shadow-sm p-6 text-center transition-all duration-300">
            <div class="mb-6">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><i class="fas fa-camera text-4xl"></i></div>
                <h2 class="text-lg font-bold text-gray-800 mb-2">æ‹ä¸‹ç”¢å“åŒ…è£</h2>
                <p class="text-gray-500 text-sm">å¤šåœ–å•ç­”ç‰ˆ<br>æ‹å®Œä¸€å¼µï¼Œå¯æŒ‰ã€ŒåŠ æ‹ã€ç¹¼çºŒæ‹ä¸‹ä¸€å¼µï¼</p>
                <div class="mt-4 inline-block bg-blue-50 text-blue-600 text-xs px-3 py-1 rounded-full border border-blue-100"><i class="fas fa-user-circle mr-1"></i>ç›®å‰å¸³è™Ÿï¼š<span id="homeUserId" class="font-bold">...</span></div>
            </div>
            
            <div class="flex gap-3 w-full">
                <label class="flex-1 cursor-pointer">
                    <div class="bg-blue-600 text-white font-bold py-3 px-2 rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 h-full">
                        <i class="fas fa-camera text-2xl"></i>
                        <span class="text-sm">ç«‹å³æ‹ç…§</span>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(event)">
                </label>

                <label class="flex-1 cursor-pointer">
                    <div class="bg-green-600 text-white font-bold py-3 px-2 rounded-xl shadow-lg hover:bg-green-700 active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 h-full">
                        <i class="fas fa-images text-2xl"></i>
                        <span class="text-sm">å¾ç›¸ç°¿é¸</span>
                    </div>
                    <input type="file" accept="image/*" multiple class="hidden" onchange="handleFileSelect(event)">
                </label>
            </div>
        </div>

        <div id="previewSection" class="hidden space-y-4">
            <div class="bg-gray-100 rounded-xl p-2">
                <div id="previewContainer" class="flex overflow-x-auto space-x-3 pb-2 hide-scrollbar snap-x">
                    </div>
                <p class="text-xs text-center text-gray-400 mt-1"><i class="fas fa-hand-point-up"></i> å·¦å³æ»‘å‹•æª¢æŸ¥ç…§ç‰‡</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="document.getElementById('fileInput').click()" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl shadow-sm hover:bg-gray-300 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> åŠ æ‹
                </button>
                <button id="analyzeBtn" onclick="analyzeImage()" class="flex-[2] bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-sparkles"></i> é–‹å§‹åˆ†æ
                </button>
            </div>
        </div>

        <div id="loadingSection" class="hidden flex-col items-center justify-center py-10 text-center">
            <div class="loader mb-4"></div>
            <h3 class="text-lg font-bold text-gray-700">æ­£åœ¨è§£è®€ç”¢å“è³‡è¨Š...</h3>
            <p class="text-gray-500 text-sm mt-2" id="loadingText">è™•ç†å½±åƒä¸­...</p>
        </div>

        <div id="resultSection" class="hidden space-y-4 animate-fade-in pb-10">
            <button id="historyBackBtn" onclick="window.history.back()" class="hidden mb-3 text-blue-600 font-bold flex items-center hover:text-blue-800 transition"><i class="fas fa-chevron-left mr-1"></i> è¿”å›ç´€éŒ„åˆ—è¡¨</button>
            <div id="saveStatusMsg" class="hidden p-3 rounded-lg text-sm mb-4"></div>

            <div id="resultImageContainer" class="hidden mb-4"></div>

            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">ç”¢å“åç¨±</h3>
                <h2 id="resName" class="text-xl font-bold text-gray-800"></h2>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">é‡é»ç¿»è­¯</h3>
                <p id="resTranslation" class="text-gray-700 leading-relaxed"></p>
            </div>
            <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl shadow-sm p-5 border border-indigo-100">
                <h3 class="font-bold text-indigo-900 mb-2">ç™½è©±æ–‡æ‡¶äººåŒ…</h3>
                <p id="resExplanation" class="text-gray-800 font-medium leading-relaxed"></p>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mt-6">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-3 flex justify-between items-center text-white">
                    <h3 class="font-bold text-sm"><i class="fas fa-robot mr-2"></i>é‚„æœ‰å•é¡Œï¼Ÿå•å• AI</h3>
                </div>
                <div id="chatHistory" class="p-4 space-y-4 max-h-[300px] overflow-y-auto bg-gray-50 text-sm">
                    <div class="flex gap-2">
                        <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot"></i></div>
                        <div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-gray-700 border border-gray-100">
                            å°é€™å€‹ç”¢å“é‚„æœ‰ç–‘å•å—ï¼Ÿä¾‹å¦‚æˆåˆ†ã€ç†±é‡æˆ–æ˜¯ä½¿ç”¨æ–¹æ³•ï¼Ÿæ­¡è¿éš¨æ™‚å•æˆ‘ï¼
                        </div>
                    </div>
                </div>
                <div class="p-3 bg-white border-t border-gray-100 flex gap-2">
                    <input type="text" id="chatInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." class="flex-grow bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:bg-white outline-none transition" onkeypress="handleChatKey(event)">
                    <button onclick="sendChatMessage()" id="sendChatBtn" class="bg-purple-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-purple-700 active:scale-95 transition shadow-sm"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="historySection" class="hidden animate-fade-in">
            <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-clock mr-2 text-blue-500"></i>åˆ†æç´€éŒ„</h2>
                <button onclick="clearHistory()" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-50 transition">æ¸…ç©ºç´€éŒ„</button>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg mb-4 text-sm border border-blue-100">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-blue-800 overflow-hidden">
                        <span class="block text-xs text-blue-500">ç›®å‰å¸³è™Ÿ ID</span>
                        <span id="displayUserId" class="font-mono font-bold text-base truncate block max-w-[150px]">...</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyShareLink()" class="flex-shrink-0 bg-white text-blue-600 border border-blue-200 px-2 py-1.5 rounded-lg shadow-sm hover:bg-blue-50 transition" title="è¤‡è£½é€£çµ"><i class="fas fa-link"></i></button>
                        <button onclick="switchUser()" class="flex-shrink-0 bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded-lg shadow-sm hover:bg-blue-100 transition active:scale-95"><i class="fas fa-exchange-alt mr-1"></i>åˆ‡æ›</button>
                    </div>
                </div>
                <div class="text-xs text-blue-400"><i class="fas fa-info-circle mr-1"></i>åˆ†äº«é€£çµç¯„ä¾‹ï¼š<br><span id="shareLinkExample" class="select-all bg-blue-100/50 px-1 rounded">...</span></div>
            </div>
            <div id="historyList" class="space-y-3 pb-10"></div>
            <button onclick="resetApp()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl mt-4">è¿”å›é¦–é </button>
        </div>
    </main>

    <div id="imageModal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0" onclick="closeImageModal()">
        <button class="absolute top-4 right-4 text-white/80 hover:text-white text-4xl focus:outline-none w-10 h-10 flex items-center justify-center bg-black/50 rounded-full">&times;</button>
        <img id="modalImage" class="max-w-full max-h-[90vh] object-contain rounded shadow-2xl scale-95 transition-transform duration-200" src="" alt="Full size" onclick="event.stopPropagation()">
    </div>
    
    <div id="installModal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0" onclick="closeInstallModal()">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeInstallModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-mobile-alt"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">å®‰è£åˆ°æ‰‹æ©Ÿæ¡Œé¢</h3>
                <p class="text-sm text-gray-500 mb-6">åƒ App ä¸€æ¨£ä½¿ç”¨ï¼Œæ–¹ä¾¿åˆå¿«é€Ÿï¼</p>
                <div id="iosInstall" class="hidden text-left bg-gray-50 p-4 rounded-lg border border-gray-100"><p class="text-sm text-gray-700 font-bold mb-2">ğŸ‘‰ iOS ä½¿ç”¨è€…ï¼š</p><ol class="list-decimal list-inside text-sm text-gray-600 space-y-2"><li>é»æ“Šä¸‹æ–¹ <strong class="text-blue-600"><i class="fas fa-share-square"></i> åˆ†äº«</strong></li><li>é»æ“Š <strong class="text-blue-600"><i class="fas fa-plus-square"></i> åŠ å…¥ä¸»ç•«é¢</strong></li><li>é»æ“Š <strong>æ–°å¢</strong></li></ol></div>
                <div id="androidInstall" class="hidden text-left bg-gray-50 p-4 rounded-lg border border-gray-100"><p class="text-sm text-gray-700 font-bold mb-2">ğŸ‘‰ Android ä½¿ç”¨è€…ï¼š</p><ol class="list-decimal list-inside text-sm text-gray-600 space-y-2"><li>é»æ“Šå³ä¸Šè§’ <strong class="text-blue-600"><i class="fas fa-ellipsis-v"></i> é¸å–®</strong></li><li>é»æ“Š <strong class="text-blue-600"><i class="fas fa-mobile-alt"></i> åŠ åˆ°ä¸»ç•«é¢</strong></li><li>é»æ“Š <strong>æ–°å¢</strong></li></ol></div>
                <div id="pcInstall" class="hidden text-left bg-gray-50 p-4 rounded-lg border border-gray-100"><p class="text-sm text-gray-700 font-bold mb-2">ğŸ‘‰ é›»è…¦ç‰ˆï¼š</p><p class="text-sm text-gray-600">æŒ‰ <kbd>Ctrl</kbd> + <kbd>D</kbd> åŠ å…¥æ›¸ç±¤ã€‚</p></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // âš ï¸ é—œéµï¼šè«‹å°‡é€™è£¡æ›æˆæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (çµå°¾ /exec)
        // ============================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwxJpMdE7vgn__dFK85O017ruKczfVUn2-o91H9C1YOuRzVeSqUTV0hJvYxlRfcF4G9/exec"; 

        let currentBase64Array = []; 
        let loadingInterval = null;
        let currentProductContext = {}; 
        const STORAGE_KEY = 'ai_product_history_v2'; 
        const USER_ID_KEY = 'ai_product_user_id';
        
        // ç¶²å€åƒæ•¸è§£æ
        const urlParams = new URLSearchParams(window.location.search);
        const urlUserId = urlParams.get('uid');

        let userId;
        let shouldSync = false;

        if (urlUserId && urlUserId.trim() !== "") {
            userId = urlUserId.replace(/[<>"'/\\`]/g, '');
            localStorage.setItem(USER_ID_KEY, userId);
            shouldSync = true;
        } else {
            userId = localStorage.getItem(USER_ID_KEY) || 'user_' + Math.random().toString(36).substr(2, 6);
            localStorage.setItem(USER_ID_KEY, userId);
        }
        
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const previewContainer = document.getElementById('previewContainer');
        const loadingSection = document.getElementById('loadingSection');
        const resultSection = document.getElementById('resultSection');
        const historySection = document.getElementById('historySection'); 
        const saveStatusMsg = document.getElementById('saveStatusMsg');
        const resultImageContainer = document.getElementById('resultImageContainer');
        const displayUserId = document.getElementById('displayUserId');
        const homeUserId = document.getElementById('homeUserId'); 
        const shareLinkExample = document.getElementById('shareLinkExample');
        const historyBackBtn = document.getElementById('historyBackBtn'); 
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const installModal = document.getElementById('installModal');
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const fileInput = document.getElementById('fileInput'); 
        
        const loadingSteps = ["è™•ç†å¤šå¼µå½±åƒ...", "å‘¼å« AI å¤§è…¦...", "ç¶œåˆåˆ†ææˆåˆ†...", "æ­£åœ¨å­˜å…¥æ‚¨çš„å°ˆå±¬é›²ç«¯..."];

        updateUserInfoDisplay();
        if (shouldSync) setTimeout(syncHistoryFromServer, 500);

        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.view === 'history') {
                showHistory(false); 
            } else if (!event.state || event.state.view === 'home') {
                if (!previewSection.classList.contains('hidden') && currentBase64Array.length > 0) {
                    // Do nothing
                } else {
                    resetApp(false); 
                }
            }
        });

        // ============================================
        //  API å‘¼å«å‡½å¼ (å·²ç¢ºèªä¿®å¾©)
        // ============================================
        async function callGAS(action, payload) {
            if(!GAS_API_URL || GAS_API_URL.includes("æ‚¨çš„-DEPLOYMENT-ID")) {
                alert("è«‹å…ˆä¿®æ”¹ index.html ä¸­çš„ GAS_API_URL ç‚ºæ‚¨è‡ªå·±çš„ GAS éƒ¨ç½²ç¶²å€ï¼");
                throw new Error("API URL not set");
            }

            const body = JSON.stringify({
                action: action,
                userId: userId,
                ...payload
            });

            const response = await fetch(GAS_API_URL, {
                method: 'POST',  
                body: body,      
                headers: {
                    "Content-Type": "text/plain;charset=utf-8", 
                },
            });

            const json = await response.json();
            if (json.error) throw new Error(json.error);
            return json;
        }

        // ============================================
        //  é‚è¼¯å‡½å¼
        // ============================================

        function updateUserInfoDisplay() {
            if (displayUserId) displayUserId.innerText = userId;
            if (homeUserId) homeUserId.innerText = userId;
            const currentUrl = window.location.href.split('?')[0];
            if (shareLinkExample) shareLinkExample.innerText = currentUrl + '?uid=' + userId;
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width; let height = img.height;
                            const maxDim = 1024; 
                            if (width > maxDim || height > maxDim) {
                                if (width > height) { height *= maxDim / width; width = maxDim; } else { width *= maxDim / height; height = maxDim; }
                            }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            const newImages = await Promise.all(promises);
            const startIndex = currentBase64Array.length;
            currentBase64Array = currentBase64Array.concat(newImages);

            newImages.forEach((base64, index) => {
                const div = document.createElement('div');
                div.className = "flex-shrink-0 w-32 h-32 rounded-lg overflow-hidden border-2 border-white shadow-sm snap-center relative bg-gray-200";
                
                // âš ï¸ ä¿®æ­£ï¼šæ”¹ç”¨ createElement é¿å… onclick å­—ä¸²éŒ¯èª¤
                const img = document.createElement('img');
                img.src = base64;
                img.className = "w-full h-full object-cover cursor-zoom-in";
                img.onclick = function() { openImageModal(base64); };
                
                const badge = document.createElement('div');
                badge.className = "absolute top-1 right-1 bg-black/60 text-white text-xs px-1.5 rounded-full";
                badge.innerText = startIndex + index + 1;
                
                div.appendChild(img);
                div.appendChild(badge);
                previewContainer.appendChild(div);
            });
            
            setTimeout(() => { previewContainer.scrollLeft = previewContainer.scrollWidth; }, 100);
            
            document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');

            historySection.classList.add('hidden');
            uploadSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
        }

        function resetApp(pushState = true) {
            if (pushState) window.history.pushState({view: 'home'}, '', window.location.pathname);
            
            document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');
            currentBase64Array = []; 
            previewContainer.innerHTML = ''; 
            if (loadingInterval) clearInterval(loadingInterval);
            
            uploadSection.classList.remove('hidden');
            previewSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            loadingSection.style.display = '';
            resultSection.classList.add('hidden');
            historySection.classList.add('hidden'); 
            saveStatusMsg.classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function navigateToHistory() { showHistory(true); }

        function showHistory(pushState = true) {
            if (pushState) window.history.pushState({view: 'history'}, '', '#history');
            uploadSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            loadingSection.style.display = '';
            resultSection.classList.add('hidden');
            historySection.classList.remove('hidden');
            renderHistoryList();
            window.scrollTo(0, 0);
        }

        async function analyzeImage() {
            if (currentBase64Array.length === 0) return;
            
            previewSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            loadingSection.style.display = 'flex';
            let stepIndex = 0;
            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(function() {
                document.getElementById('loadingText').innerText = loadingSteps[stepIndex % loadingSteps.length];
                stepIndex++;
            }, 1500);

            const base64List = currentBase64Array.map(b => b.split(',')[1]);
            
            try {
                const result = await callGAS('analyze', { base64DataList: base64List });
                if (loadingInterval) clearInterval(loadingInterval);
                renderResult(result); 
                saveToHistory(result);
            } catch (error) {
                handleAnalysisError(error);
            }
        }

        function handleAnalysisError(error) {
            if (loadingInterval) clearInterval(loadingInterval);
            alert("åˆ†æç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message + "\n\nä¸ç”¨æ“”å¿ƒï¼Œç…§ç‰‡é‚„åœ¨ï¼è«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡æŒ‰éˆ•ã€‚");
            loadingSection.classList.add('hidden');
            previewSection.classList.remove('hidden'); 
            resultSection.classList.add('hidden');
        }

        function renderResult(data, fromHistory = false) {
            currentProductContext = { productName: data.productName, translation: data.translation, explanation: data.explanation };
            chatHistory.innerHTML = '<div class="flex gap-2"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-gray-700 border border-gray-100">å°é€™å€‹ç”¢å“é‚„æœ‰ç–‘å•å—ï¼Ÿä¾‹å¦‚æˆåˆ†ã€ç†±é‡æˆ–æ˜¯ä½¿ç”¨æ–¹æ³•ï¼Ÿæ­¡è¿éš¨æ™‚å•æˆ‘ï¼</div></div>';

            loadingSection.classList.add('hidden');
            loadingSection.style.display = '';
            resultSection.classList.remove('hidden');
            historySection.classList.add('hidden'); 
            uploadSection.classList.add('hidden'); 

            if (fromHistory) { historyBackBtn.classList.remove('hidden'); } else { historyBackBtn.classList.add('hidden'); }

            document.getElementById('resName').innerText = data.productName || "æœªçŸ¥ç”¢å“";
            document.getElementById('resTranslation').innerText = data.translation || "ç„¡å…§å®¹";
            document.getElementById('resExplanation').innerText = data.explanation || "ç„¡è§£é‡‹";

            let images = [];
            if (currentBase64Array && currentBase64Array.length > 0) {
                images = currentBase64Array;
            } else if (data.imageUrls && Array.isArray(data.imageUrls)) {
                images = data.imageUrls;
            } else if (data.imageUrl) {
                images = [data.imageUrl];
            }

            resultImageContainer.innerHTML = '';
            
            if (images.length > 0) {
                resultImageContainer.className = "flex overflow-x-auto space-x-3 pb-2 hide-scrollbar snap-x mb-4"; 
                resultImageContainer.classList.remove('hidden', 'rounded-xl', 'overflow-hidden', 'shadow-sm', 'border', 'border-gray-200', 'bg-gray-50', 'relative', 'group');

                images.forEach((src, index) => {
                    const div = document.createElement('div');
                    if (images.length === 1) {
                        div.className = "w-full h-64 rounded-lg overflow-hidden border border-gray-200 shadow-sm relative bg-white flex-shrink-0";
                    } else {
                        div.className = "w-64 h-64 rounded-lg overflow-hidden border border-gray-200 shadow-sm snap-center relative bg-white flex-shrink-0";
                    }
                    
                    // âš ï¸ ä¿®æ­£ï¼šæ”¹ç”¨ createElement é¿å… onclick å­—ä¸²éŒ¯èª¤
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = "w-full h-full object-cover cursor-zoom-in";
                    img.onclick = function() { openImageModal(src); };
                    
                    div.appendChild(img);
                    
                    if (images.length > 1) {
                        div.innerHTML += '<div class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full pointer-events-none">' + (index + 1) + '/' + images.length + '</div>';
                    } else {
                        div.innerHTML += '<div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded pointer-events-none"><i class="fas fa-search-plus mr-1"></i>æ”¾å¤§</div>';
                    }
                    resultImageContainer.appendChild(div);
                });
                resultImageContainer.classList.remove('hidden');
            } else {
                resultImageContainer.classList.add('hidden');
            }

            saveStatusMsg.className = "hidden p-3 rounded-lg text-sm mb-4";
            if (data.saveSuccess) {
                saveStatusMsg.innerHTML = '<i class="fas fa-check-circle mr-1"></i> å·²å„²å­˜è‡³æ‚¨çš„å°ˆå±¬è³‡æ–™å¤¾ï¼';
                saveStatusMsg.className = "block bg-green-100 text-green-700 p-3 rounded-lg text-sm mb-4";
            } else if (data.saveError) {
                saveStatusMsg.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> å„²å­˜å¤±æ•—ï¼š' + data.saveError;
                saveStatusMsg.className = "block bg-red-100 text-red-700 p-3 rounded-lg text-sm mb-4";
            }

            setTimeout(function() { window.scrollTo({ top: 0, behavior: 'auto' }); }, 50);
        }

        function handleChatKey(e) { if(e.key === 'Enter') sendChatMessage(); }

        async function sendChatMessage() {
            const question = chatInput.value.trim();
            if (!question) return;

            const userHtml = '<div class="flex gap-2 justify-end animate-fade-in"><div class="bg-purple-600 text-white p-3 rounded-l-xl rounded-br-xl shadow-sm max-w-[85%]">' + question + '</div></div>';
            chatHistory.insertAdjacentHTML('beforeend', userHtml);
            chatInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const loadingId = 'chat-loading-' + Date.now();
            const loadingHtml = '<div id="' + loadingId + '" class="flex gap-2 animate-fade-in"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-gray-500 border border-gray-100 flex items-center"><span class="chat-loader"></span><span class="chat-loader"></span><span class="chat-loader"></span></div></div>';
            chatHistory.insertAdjacentHTML('beforeend', loadingHtml);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const imagesDataToSend = currentBase64Array.length > 0 ? currentBase64Array.map(b => b.split(',')[1]) : null;

            try {
                const response = await callGAS('chat', { 
                    question: question,
                    productContext: currentProductContext,
                    base64DataList: imagesDataToSend
                });

                document.getElementById(loadingId).remove();
                const aiHtml = '<div class="flex gap-2 animate-fade-in"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-gray-700 border border-gray-100">' + response.reply + '</div></div>';
                chatHistory.insertAdjacentHTML('beforeend', aiHtml);
                chatHistory.scrollTop = chatHistory.scrollHeight;

            } catch (error) {
                document.getElementById(loadingId).remove();
                const errHtml = '<div class="flex gap-2"><div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-exclamation-circle"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-red-600 border border-red-100">æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚éŒ¯èª¤ï¼š' + error.message + '</div></div>';
                chatHistory.insertAdjacentHTML('beforeend', errHtml);
            }
        }

        function saveToHistory(data) {
            try {
                const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const newItem = { 
                    id: Date.now(), 
                    timestamp: new Date().getTime(), 
                    productName: data.productName, 
                    translation: data.translation, 
                    explanation: data.explanation, 
                    imageUrl: data.imageUrl,
                    imageUrls: data.imageUrls || (data.imageUrl ? [data.imageUrl] : [])
                };
                history.unshift(newItem);
                if (history.length > 20) { history.pop(); }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            } catch (e) { console.error("å„²å­˜å¤±æ•—", e); }
        }

        function renderHistoryList() {
            const listEl = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            if (history.length === 0) { listEl.innerHTML = '<div class="text-center py-10 text-gray-400"><i class="fas fa-inbox text-4xl mb-3 block"></i>ç›®å‰æ²’æœ‰ç´€éŒ„<br><span class="text-xs">è‹¥å‰›åˆ‡æ›å¸³è™Ÿï¼Œå»ºè­°é»æ“Šã€Œåˆ‡æ›/åŒæ­¥ã€æŒ‰éˆ•ä¾†è¼‰å…¥é›²ç«¯è³‡æ–™</span></div>'; return; }

            listEl.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0');
                const images = item.imageUrls || (item.imageUrl ? [item.imageUrl] : []);
                const firstImage = images.length > 0 ? images[0] : null;
                const countBadge = images.length > 1 ? '<span class="absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-1.5 rounded-full">+' + (images.length - 1) + '</span>' : '';

                var imgHtml = firstImage 
                    ? '<div class="w-16 h-16 flex-shrink-0 bg-gray-100 rounded-lg overflow-hidden mr-3 relative"><img src="' + firstImage + '" class="w-full h-full object-cover">' + countBadge + '</div>'
                    : '<div class="w-16 h-16 flex-shrink-0 bg-gray-100 rounded-lg flex items-center justify-center mr-3 text-gray-400"><i class="fas fa-image"></i></div>';

                return '<div class="history-card bg-white rounded-xl shadow-sm p-3 border border-gray-100 cursor-pointer transition flex items-start" onclick="viewHistoryItem(' + index + ')">' + imgHtml + '<div class="flex-grow min-w-0"><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-gray-800 text-md truncate pr-2">' + (item.productName || 'æœªçŸ¥ç”¢å“') + '</h3><span class="text-xs text-gray-400 whitespace-nowrap">' + dateStr + '</span></div><p class="text-sm text-gray-500 line-clamp-2">' + (item.explanation || 'ç„¡èªªæ˜') + '</p></div></div>';
            }).join('');
        }

        function viewHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const item = history[index];
            if (item) {
                currentBase64Array = []; 
                window.history.pushState({view: 'item'}, '', '#item');
                renderResult(item, true); 
                saveStatusMsg.classList.add('hidden'); 
            }
        }

        function clearHistory() { if (confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬åœ°ç´€éŒ„å—ï¼Ÿ(é›²ç«¯è³‡æ–™ä¸æœƒåˆªé™¤)")) { localStorage.removeItem(STORAGE_KEY); renderHistoryList(); } }

        async function syncHistoryFromServer() {
            console.log("æ­£åœ¨åŒæ­¥è³‡æ–™...");
            try {
                const serverHistory = await callGAS('getHistory', {});
                if (serverHistory && serverHistory.length > 0) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(serverHistory));
                    if (!historySection.classList.contains('hidden')) { renderHistoryList(); }
                }
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—", e);
            }
        }

        async function switchUser() {
            const newId = prompt("è«‹è¼¸å…¥å¸³è™Ÿ ID (å»ºè­°è¨­ç‚º Mom, Me ç­‰ç°¡å–®åç¨±)\n\nè‹¥è©² ID å·²æœ‰é›²ç«¯ç´€éŒ„ï¼Œå°‡è‡ªå‹•åŒæ­¥ã€‚", userId);
            if (newId && newId.trim() !== "") {
                if (confirm("å³å°‡åˆ‡æ›è‡³å¸³è™Ÿ: " + newId + "\né€™å°‡æœƒæ¸…é™¤ç›®å‰çš„ç•«é¢ä¸¦å¾é›²ç«¯è¼‰å…¥è©²å¸³è™Ÿçš„ç´€éŒ„ã€‚")) {
                    userId = newId.trim(); 
                    localStorage.setItem(USER_ID_KEY, userId); 
                    updateUserInfoDisplay();
                    document.getElementById('historyList').innerHTML = '<div class="text-center py-10"><div class="loader mx-auto mb-2"></div><p class="text-gray-400">æ­£åœ¨é›²ç«¯åŒæ­¥è³‡æ–™...</p></div>';
                    
                    try {
                        const serverHistory = await callGAS('getHistory', {});
                        if (serverHistory && serverHistory.length > 0) { 
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(serverHistory)); 
                            renderHistoryList(); 
                            alert("åŒæ­¥æˆåŠŸï¼å·²è¼‰å…¥ " + serverHistory.length + " ç­†ç´€éŒ„ã€‚"); 
                        } else { 
                            localStorage.setItem(STORAGE_KEY, '[]'); 
                            renderHistoryList(); 
                            alert("åˆ‡æ›æˆåŠŸï¼æ­¤å¸³è™Ÿç›®å‰æ²’æœ‰é›²ç«¯ç´€éŒ„ã€‚"); 
                        }
                    } catch (err) {
                        alert("åŒæ­¥å¤±æ•—ï¼š" + err.message);
                        renderHistoryList();
                    }
                }
            }
        }

        function copyShareLink() {
            const currentUrl = window.location.href.split('?')[0];
            const shareUrl = currentUrl + '?uid=' + userId;
            const el = document.createElement('textarea'); el.value = shareUrl; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert("é€£çµå·²è¤‡è£½ï¼\næ‚¨å¯ä»¥å°‡æ­¤é€£çµå‚³çµ¦ä»–äººï¼Œå°æ–¹é–‹å•Ÿå¾Œå°‡æœƒè‡ªå‹•ç™»å…¥æ­¤å¸³è™Ÿã€‚");
        }

        function openImageModal(src) { modalImage.src = src; imageModal.classList.remove('hidden'); requestAnimationFrame(() => { imageModal.classList.remove('opacity-0'); modalImage.classList.remove('scale-95'); modalImage.classList.add('scale-100'); }); document.body.style.overflow = 'hidden'; }
        function closeImageModal() { imageModal.classList.add('opacity-0'); modalImage.classList.remove('scale-100'); modalImage.classList.add('scale-95'); setTimeout(() => { imageModal.classList.add('hidden'); modalImage.src = ''; document.body.style.overflow = ''; }, 200); }
        function showInstallPrompt() {
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(ua); const isAndroid = /android/.test(ua);
            if (isIOS) { document.getElementById('iosInstall').classList.remove('hidden'); }
            else if (isAndroid) { document.getElementById('androidInstall').classList.remove('hidden'); }
            else { document.getElementById('pcInstall').classList.remove('hidden'); }
            installModal.classList.remove('hidden'); requestAnimationFrame(() => { installModal.classList.remove('opacity-0'); });
        }
        function closeInstallModal() { installModal.classList.add('opacity-0'); setTimeout(() => { installModal.classList.add('hidden'); document.getElementById('iosInstall').classList.add('hidden'); document.getElementById('androidInstall').classList.add('hidden'); document.getElementById('pcInstall').classList.add('hidden'); }, 200); }
    </script>
</body>
</html>
