<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 產品拍立解</title>
    
    <link rel="icon" type="image/png" href="https://i.meee.com.tw/S9sSQna.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        html { height: auto; min-height: 100%; overflow-y: auto; touch-action: manipulation; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; min-height: 100vh; position: relative; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .chat-loader { width: 8px; height: 8px; background-color: #9ca3af; border-radius: 50%; animation: chat-dot 1.4s infinite ease-in-out both; display: inline-block; margin: 0 2px; }
        .chat-loader:nth-child(1) { animation-delay: -0.32s; }
        .chat-loader:nth-child(2) { animation-delay: -0.16s; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 強制 Lightbox 層級最高 */
        #imageModal { z-index: 2147483647 !important; }
        .cursor-pointer { cursor: pointer; }
        /* 文字斷行修正 */
        .break-words { word-wrap: break-word; word-break: break-word; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="flex flex-col">
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="window.showInstallPrompt()" class="text-white/90 hover:text-white transition p-1"><i class="fas fa-download text-lg"></i></button>
                <button onclick="window.navigateToHistory()" class="text-white/90 hover:text-white transition p-1"><i class="fas fa-history text-lg"></i></button>
                <h1 class="text-xl font-bold">AI 產品拍立解</h1>
            </div>
            <button onclick="window.resetApp()" class="text-sm bg-blue-700 px-3 py-1 rounded-full"><i class="fas fa-redo"></i> 重來</button>
        </div>
    </header>

    <main class="flex-grow p-4 max-w-md mx-auto w-full pb-20">
        
        <div id="uploadSection" class="bg-white rounded-2xl shadow-sm p-6 text-center">
            <div class="mb-6">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><i class="fas fa-camera text-4xl"></i></div>
                <h2 class="text-lg font-bold text-gray-800 mb-2">拍下產品包裝</h2>
                <p class="text-gray-500 text-sm">多圖問答版<br>拍完一張，可按「加拍」繼續拍下一張！</p>
                <div class="mt-4 inline-block bg-blue-50 text-blue-600 text-xs px-3 py-1 rounded-full border border-blue-100"><i class="fas fa-user-circle mr-1"></i>目前帳號：<span id="homeUserId" class="font-bold">...</span></div>
            </div>
            
            <div class="flex gap-3 w-full">
                <label class="flex-1 cursor-pointer">
                    <div class="bg-blue-600 text-white font-bold py-3 px-2 rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 h-full">
                        <i class="fas fa-camera text-2xl"></i><span class="text-sm">立即拍照</span>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" onchange="window.handleFileSelect(event)">
                </label>

                <label class="flex-1 cursor-pointer">
                    <div class="bg-green-600 text-white font-bold py-3 px-2 rounded-xl shadow-lg hover:bg-green-700 active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 h-full">
                        <i class="fas fa-images text-2xl"></i><span class="text-sm">從相簿選</span>
                    </div>
                    <input type="file" accept="image/*" multiple class="hidden" onchange="window.handleFileSelect(event)">
                </label>
            </div>
        </div>

        <div id="previewSection" class="hidden space-y-4">
            <div class="bg-gray-100 rounded-xl p-2">
                <div id="previewContainer" class="flex overflow-x-auto space-x-3 pb-2 hide-scrollbar snap-x"></div>
                <p class="text-xs text-center text-gray-400 mt-1">點擊圖片可放大</p>
            </div>
            
            <div class="flex flex-col gap-2">
                <div class="flex gap-2">
                    <label class="flex-1 cursor-pointer bg-gray-200 text-gray-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                        <i class="fas fa-camera"></i> 加拍
                        <input type="file" accept="image/*" capture="environment" class="hidden" onchange="window.handleFileSelect(event)">
                    </label>
                    <label class="flex-1 cursor-pointer bg-gray-200 text-gray-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                        <i class="fas fa-images"></i> 選圖
                        <input type="file" accept="image/*" multiple class="hidden" onchange="window.handleFileSelect(event)">
                    </label>
                </div>
                <button onclick="window.analyzeImage()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-sparkles"></i> 開始分析
                </button>
            </div>
        </div>

        <div id="loadingSection" class="hidden flex-col items-center justify-center py-10 text-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 text-sm" id="loadingText">處理中...</p>
        </div>

        <div id="resultSection" class="hidden space-y-4 pb-10">
            <button onclick="window.history.back()" class="mb-3 text-blue-600 font-bold flex items-center"><i class="fas fa-chevron-left mr-1"></i> 返回</button>
            <div id="saveStatusMsg" class="hidden p-3 rounded-lg text-sm mb-4"></div>
            <div id="resultImageContainer" class="hidden mb-4"></div>

            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">產品名稱</h3>
                <h2 id="resName" class="text-xl font-bold text-gray-800"></h2>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">重點翻譯</h3>
                <p id="resTranslation" class="text-gray-700 leading-relaxed"></p>
            </div>
            <div class="bg-blue-50 rounded-xl shadow-sm p-5">
                <h3 class="font-bold text-blue-900 mb-2">白話文懶人包</h3>
                <p id="resExplanation" class="text-gray-800"></p>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mt-6">
                <div class="bg-purple-600 text-white p-3 font-bold text-sm">問問 AI</div>
                <div id="chatHistory" class="p-4 space-y-4 max-h-[300px] overflow-y-auto bg-gray-50 text-sm"></div>
                <div class="p-3 bg-white border-t flex gap-2">
                    <input type="text" id="chatInput" placeholder="輸入問題..." class="flex-grow bg-gray-100 rounded-full px-4 py-2" onkeypress="window.handleChatKey(event)">
                    <button onclick="window.sendChatMessage()" class="bg-purple-600 text-white w-10 h-10 rounded-full"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="historySection" class="hidden animate-fade-in">
            <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                <h2 class="text-lg font-bold text-gray-800">歷史紀錄</h2>
                <button onclick="window.clearHistory()" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">清空</button>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg mb-4 text-sm border border-blue-100">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-blue-800 overflow-hidden">ID: <span id="displayUserId" class="font-mono font-bold">...</span></div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button onclick="window.copyShareLink()" class="bg-white text-blue-600 border border-blue-200 px-2 py-1 rounded text-xs whitespace-nowrap">複製連結</button>
                        <button onclick="window.switchUser()" class="bg-white text-blue-600 border border-blue-200 px-2 py-1 rounded text-xs whitespace-nowrap">切換</button>
                    </div>
                </div>
            </div>
            <div id="historyList" class="space-y-3 pb-10"></div>
            <button onclick="window.resetApp()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl mt-4">返回首頁</button>
        </div>
    </main>

    <div id="imageModal" style="display: none;" class="fixed inset-0 bg-black/95 flex items-center justify-center p-2 backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="window.closeImageModal()">
        <button onclick="window.closeImageModal()" class="absolute top-4 right-4 z-[10000] text-white bg-gray-800/50 rounded-full w-12 h-12 flex items-center justify-center">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <img id="modalImage" class="max-w-full max-h-[90vh] object-contain rounded shadow-2xl scale-95 transition-transform duration-300" src="" alt="Full size" onclick="event.stopPropagation()">
    </div>
    
    <div id="installModal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" onclick="window.closeInstallModal()">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="window.closeInstallModal()" class="absolute top-3 right-3 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-2">安裝到手機</h3>
                <p class="text-sm text-gray-500 mb-4">點擊瀏覽器選單中的「加入主畫面」即可。</p>
                <div id="iosInstall" class="hidden text-sm text-left bg-gray-50 p-3 rounded">iOS: 分享按鈕 <i class="fas fa-share-square"></i> -> 加入主畫面</div>
                <div id="androidInstall" class="hidden text-sm text-left bg-gray-50 p-3 rounded">Android: 選單 <i class="fas fa-ellipsis-v"></i> -> 加到主畫面</div>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // ⭐⭐⭐ 網址設定區 (請小心修改引號內的網址) ⭐⭐⭐
        // =========================================================================
        
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwxJpMdE7vgn__dFK85O017ruKczfVUn2-o91H9C1YOuRzVeSqUTV0hJvYxlRfcF4G9/exec"; 

        // =========================================================================
        //  以下程式碼請勿修改
        // =========================================================================

        let currentBase64Array = []; 
        let loadingInterval = null;
        let currentProductContext = {}; 
        const STORAGE_KEY = 'ai_product_history_v2'; 
        const USER_ID_KEY = 'ai_product_user_id';
        window.userId = ''; 

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('uid');
            
            if (urlUserId && urlUserId.trim() !== "") {
                window.userId = urlUserId.replace(/[<>"'/\\`]/g, '');
                localStorage.setItem(USER_ID_KEY, window.userId);
            } else {
                window.userId = localStorage.getItem(USER_ID_KEY) || 'user_' + Math.random().toString(36).substr(2, 6);
                localStorage.setItem(USER_ID_KEY, window.userId);
            }
            
            updateUserInfoDisplay();
            
            window.onpopstate = function(event) {
                if (event.state) {
                    if (event.state.view === 'history') showSection('history');
                    else if (event.state.view === 'home') showSection('home');
                    else if (event.state.view === 'result') showSection('result');
                } else {
                    showSection('home');
                }
            };
            
            history.replaceState({view: 'home'}, '', window.location.pathname);
        });

        // 核心：畫面切換 (含強力清除樣式)
        function showSection(sectionName) {
            const sections = ['uploadSection', 'previewSection', 'loadingSection', 'resultSection', 'historySection'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('hidden');
                    el.style.display = ''; 
                }
            });
            
            if (sectionName === 'home') {
                if (currentBase64Array.length > 0) document.getElementById('previewSection').classList.remove('hidden');
                else document.getElementById('uploadSection').classList.remove('hidden');
            } else if (sectionName === 'history') {
                document.getElementById('historySection').classList.remove('hidden');
                renderHistoryList();
            } else if (sectionName === 'result') {
                document.getElementById('resultSection').classList.remove('hidden');
            } else if (sectionName === 'loading') {
                const loader = document.getElementById('loadingSection');
                loader.classList.remove('hidden');
                loader.style.display = 'flex'; 
            }
        }

        window.openImageModal = function(src) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            if (!modal || !img) return;
            img.src = src; 
            modal.style.display = 'flex';
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
            img.classList.remove('scale-95');
            img.classList.add('scale-100');
            document.body.style.overflow = 'hidden';
        }

        window.closeImageModal = function() { 
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            if (!modal) return;
            modal.classList.add('opacity-0');
            if(img) { img.classList.remove('scale-100'); img.classList.add('scale-95'); }
            setTimeout(() => { 
                modal.style.display = 'none'; 
                if(img) img.src = ''; 
                document.body.style.overflow = ''; 
            }, 300);
        }

        async function callGAS(action, payload) {
            if(!GAS_API_URL || GAS_API_URL.includes("您的-DEPLOYMENT-ID")) {
                alert("請設定正確的 GAS 網址！");
                throw new Error("API URL error");
            }
            const body = JSON.stringify({ action: action, userId: window.userId, ...payload });
            const response = await fetch(GAS_API_URL, {
                method: 'POST',  
                body: body,      
                headers: { "Content-Type": "text/plain;charset=utf-8" },
            });
            const json = await response.json();
            if (json.error) throw new Error(json.error);
            return json;
        }

        window.updateUserInfoDisplay = function() {
            const el1 = document.getElementById('homeUserId');
            const el2 = document.getElementById('displayUserId');
            if (el1) el1.innerText = window.userId;
            if (el2) el2.innerText = window.userId;
        }

        window.handleFileSelect = async function(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            const max = 1024;
                            if (w > max || h > max) {
                                if (w > h) { h *= max / w; w = max; } else { w *= max / h; h = max; }
                            }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            const newImages = await Promise.all(promises);
            const startIndex = currentBase64Array.length;
            currentBase64Array = currentBase64Array.concat(newImages);

            newImages.forEach((base64, index) => {
                const div = document.createElement('div');
                div.className = "flex-shrink-0 w-32 h-32 rounded-lg overflow-hidden border-2 border-white shadow-sm snap-center relative bg-gray-200";
                div.innerHTML = `<img src="${base64}" class="w-full h-full object-cover cursor-pointer" onclick="window.openImageModal(this.src)">`;
                const badge = document.createElement('div');
                badge.className = "absolute top-1 right-1 bg-black/60 text-white text-xs px-1.5 rounded-full pointer-events-none";
                badge.innerText = startIndex + index + 1;
                div.appendChild(badge);
                document.getElementById('previewContainer').appendChild(div);
            });
            
            document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');
            showSection('home');
        }

        window.resetApp = function() {
            currentBase64Array = []; 
            document.getElementById('previewContainer').innerHTML = ''; 
            if (loadingInterval) clearInterval(loadingInterval);
            history.pushState({view: 'home'}, '', '#home');
            showSection('home');
            window.scrollTo(0, 0);
        }

        window.navigateToHistory = function() { 
            history.pushState({view: 'history'}, '', '#history');
            showSection('history');
        }

        window.analyzeImage = async function() {
            if (currentBase64Array.length === 0) return;
            showSection('loading');
            let step = 0;
            const steps = ["處理影像...", "AI 分析中...", "翻譯成中文...", "整理結果..."];
            loadingInterval = setInterval(() => {
                document.getElementById('loadingText').innerText = steps[step % steps.length];
                step++;
            }, 1500);

            try {
                const result = await callGAS('analyze', { base64DataList: currentBase64Array.map(b => b.split(',')[1]) });
                clearInterval(loadingInterval);
                history.pushState({view: 'result'}, '', '#result');
                renderResult(result); 
                saveToHistory(result);
            } catch (error) {
                clearInterval(loadingInterval);
                alert("錯誤：" + error.message);
                showSection('home');
            }
        }

        window.renderResult = function(data, fromHistory = false) {
            currentProductContext = data;
            document.getElementById('resName').innerText = data.productName || "未知";
            document.getElementById('resTranslation').innerText = data.translation || "無";
            document.getElementById('resExplanation').innerText = data.explanation || "無";
            
            const container = document.getElementById('resultImageContainer');
            container.innerHTML = '';
            container.classList.remove('hidden');
            container.className = "flex overflow-x-auto space-x-3 pb-2 hide-scrollbar snap-x mb-4";
            
            const images = data.imageUrls || (data.imageUrl ? [data.imageUrl] : currentBase64Array);
            images.forEach((src) => {
                const div = document.createElement('div');
                div.className = "w-64 h-64 rounded-lg overflow-hidden border border-gray-200 shadow-sm snap-center relative flex-shrink-0 bg-gray-100";
                div.innerHTML = `<img src="${src}" class="w-full h-full object-cover cursor-pointer" onclick="window.openImageModal(this.src)">`;
                container.appendChild(div);
            });

            document.getElementById('chatHistory').innerHTML = '<div class="flex gap-2"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-gray-700 border border-gray-100">有問題歡迎問我！</div></div>';
            showSection('result');
            window.scrollTo(0, 0);
        }

        window.handleChatKey = function(e) { if(e.key === 'Enter') window.sendChatMessage(); }

        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const q = input.value.trim();
            if (!q) return;
            
            const chat = document.getElementById('chatHistory');
            chat.innerHTML += `<div class="flex gap-2 justify-end mb-2"><div class="bg-purple-600 text-white p-3 rounded-l-xl rounded-br-xl shadow-sm max-w-[85%]">${q}</div></div>`;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;

            const loadId = 'load-' + Date.now();
            chat.innerHTML += `<div id="${loadId}" class="flex gap-2 mb-2"><div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl border border-gray-100 text-gray-400">...</div></div>`;
            chat.scrollTop = chat.scrollHeight;

            try {
                const res = await callGAS('chat', { 
                    question: q, 
                    productContext: currentProductContext, 
                    base64DataList: currentBase64Array.map(b => b.split(',')[1]) 
                });
                document.getElementById(loadId).remove();
                chat.innerHTML += `<div class="flex gap-2 mb-2"><div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl border border-gray-100 text-gray-800">${res.reply}</div></div>`;
            } catch (e) {
                document.getElementById(loadId).innerText = "錯誤";
            }
            chat.scrollTop = chat.scrollHeight;
        }

        window.saveToHistory = function(data) {
            const savedHistory = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            savedHistory.unshift({ 
                id: Date.now(), 
                timestamp: Date.now(), 
                productName: data.productName, 
                translation: data.translation, 
                explanation: data.explanation, 
                imageUrls: data.imageUrls || [data.imageUrl] 
            });
            if (savedHistory.length > 20) savedHistory.pop();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedHistory));
        }

        window.renderHistoryList = function() {
            const list = document.getElementById('historyList');
            const savedHistory = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (savedHistory.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400">無紀錄</div>';
                return;
            }
            list.innerHTML = savedHistory.map((item, idx) => {
                const img = (item.imageUrls && item.imageUrls[0]) || '';
                const date = new Date(item.timestamp).toLocaleString();
                return `<div class="bg-white rounded-xl shadow-sm p-3 border border-gray-100 flex items-start cursor-pointer" onclick="window.viewHistoryItem(${idx})">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden mr-3 flex-shrink-0"><img src="${img}" class="w-full h-full object-cover"></div>
                    <div class="flex-grow min-w-0">
                        <div class="font-bold text-gray-800 line-clamp-2 break-words mb-1">${item.productName}</div>
                        <div class="text-xs text-gray-400">${date}</div>
                    </div>
                </div>`;
            }).join('');
        }

        window.viewHistoryItem = function(idx) {
            const savedHistory = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (savedHistory[idx]) {
                currentBase64Array = []; 
                window.history.pushState({view: 'result'}, '', '#result');
                showSection('result');
                renderResult(savedHistory[idx], true);
            }
        }

        window.clearHistory = function() {
            if(confirm("確定清空？")) { localStorage.removeItem(STORAGE_KEY); renderHistoryList(); }
        }

        window.syncHistoryFromServer = async function() {
            console.log("正在同步資料...");
            try {
                const serverHistory = await callGAS('getHistory', {});
                if (serverHistory && serverHistory.length > 0) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(serverHistory));
                    if (!document.getElementById('historySection').classList.contains('hidden')) { renderHistoryList(); }
                }
            } catch (e) {
                console.error("同步失敗", e);
            }
        }

        window.switchUser = async function() {
            const newId = prompt("請輸入帳號 ID (建議設為 Mom, Me 等簡單名稱)\n\n若該 ID 已有雲端紀錄，將自動同步。", window.userId);
            if (newId && newId.trim() !== "") {
                if (confirm("即將切換至帳號: " + newId + "\n這將會清除目前的畫面並從雲端載入該帳號的紀錄。")) {
                    window.userId = newId.trim(); 
                    localStorage.setItem(USER_ID_KEY, window.userId); 
                    updateUserInfoDisplay();
                    document.getElementById('historyList').innerHTML = '<div class="text-center py-10"><div class="loader mx-auto mb-2"></div><p class="text-gray-400">正在雲端同步資料...</p></div>';
                    
                    try {
                        const serverHistory = await callGAS('getHistory', {});
                        if (serverHistory && serverHistory.length > 0) { 
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(serverHistory)); 
                            renderHistoryList(); 
                            alert("同步成功！已載入 " + serverHistory.length + " 筆紀錄。"); 
                        } else { 
                            localStorage.setItem(STORAGE_KEY, '[]'); 
                            renderHistoryList(); 
                            alert("切換成功！此帳號目前沒有雲端紀錄。"); 
                        }
                    } catch (err) {
                        alert("同步失敗：" + err.message);
                        renderHistoryList();
                    }
                }
            }
        }

        window.copyShareLink = function() {
            const currentUrl = window.location.href.split('?')[0];
            const shareUrl = currentUrl + '?uid=' + window.userId;
            const el = document.createElement('textarea'); el.value = shareUrl; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert("連結已複製！\n您可以將此連結傳給他人，對方開啟後將會自動登入此帳號。");
        }

        window.showInstallPrompt = function() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.indexOf('iphone') > -1 || ua.indexOf('ipad') > -1) document.getElementById('iosInstall').classList.remove('hidden');
            else if (ua.indexOf('android') > -1) document.getElementById('androidInstall').classList.remove('hidden');
            document.getElementById('installModal').classList.remove('hidden');
        }
        window.closeInstallModal = function() { installModal.classList.add('opacity-0'); setTimeout(() => { installModal.classList.add('hidden'); document.getElementById('iosInstall').classList.add('hidden'); document.getElementById('androidInstall').classList.add('hidden'); document.getElementById('pcInstall').classList.add('hidden'); }, 200); }

    </script>
</body>
</html>
